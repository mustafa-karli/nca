CREATE TABLE REQUEST_FOR_PROPOSAL (
  RFP_ID               INTEGER        NOT NULL,
  OWNER_ID             INTEGER        NOT NULL,
  PURCHASE_AREA        INTEGER        NOT NULL,
  USERNAME             VARCHAR(30)    NOT NULL,
  CAPTION              VARCHAR(250)   NOT NULL,
  REQUEST_DATE         TIMESTAMP      NOT NULL,
  END_OF_PROPOSAL      TIMESTAMP      NOT NULL,
  DELIVERY_DATE        TIMESTAMP      NOT NULL,
  CONSORTIUM_ALLOWED   CHAR(1)        NOT NULL,
  PARTIAL_ALLOWED      CHAR(1)        NOT NULL,
  DELIVERY_ADDRESS     SMALLINT       NOT NULL,
  STATUS               CHAR(1)        NOT NULL,
    CONSTRAINT REQUEST_FOR_PROPOSAL_PK PRIMARY KEY (RFP_ID),
    CONSTRAINT RFP_DELIVERY_ADDRESS    FOREIGN KEY (OWNER_ID,DELIVERY_ADDRESS) REFERENCES PARTNER_ADDRESS (BUSINESS_PARTNER_ID, ADDRESS_ID)
);



CREATE TABLE REQUEST_FOR_PROPOSAL_ITEM (
  RFP_ID               INTEGER         NOT NULL,
  LINE                 SMALLINT        NOT NULL,
  MATERIAL_TYPE_ID     VARCHAR(30),
  MANUFACTURER_ID      VARCHAR(30),
  MATERIAL_ID          INTEGER,
  SPECIFICATION        VARCHAR(80)     NOT NULL,
  QUANTITY             DECIMAL(12,2)   NOT NULL,
  UNIT                 VARCHAR(3)      NOT NULL,
    CONSTRAINT REQUEST_FOR_PROPOSAL_ITEM_PK   PRIMARY KEY (RFP_ID, LINE),
    CONSTRAINT REQUEST_FOR_PROPOSAL_ITEMS     FOREIGN KEY (RFP_ID)            REFERENCES REQUEST_FOR_PROPOSAL (RFP_ID),
    CONSTRAINT RFP_ITEM_MATERIAL              FOREIGN KEY (MATERIAL_ID)       REFERENCES MATERIAL (MATERIAL_ID),
    CONSTRAINT REQUESTED_MANUFACTURE          FOREIGN KEY (MANUFACTURER_ID)   REFERENCES MANUFACTURER (MANUFACTURER_ID),
    CONSTRAINT RFP_ITEM_MATERIAL_TYPE         FOREIGN KEY (MATERIAL_TYPE_ID)  REFERENCES MATERIAL_TYPE (MATERIAL_TYPE_ID)
);

CREATE INDEX REQUEST_FOR_PROPOSAL_ITEM_IND1 ON REQUEST_FOR_PROPOSAL_ITEM (MATERIAL_ID);
CREATE INDEX REQUEST_FOR_PROPOSAL_ITEM_IND2 ON REQUEST_FOR_PROPOSAL_ITEM (MATERIAL_TYPE_ID);



CREATE TABLE RFP_PUBLISHMENT (
  RFP_ID               INTEGER         NOT NULL,
  VENDOR_ID            INTEGER         NOT NULL,
  BEGDA                TIMESTAMP       NOT NULL,
    CONSTRAINT RFP_PUBLISHMENT_PK             PRIMARY KEY (RFP_ID, VENDOR_ID),
    CONSTRAINT RFP_PUBLISHMENTS               FOREIGN KEY (RFP_ID)            REFERENCES REQUEST_FOR_PROPOSAL (RFP_ID)
);

CREATE INDEX RFP_PUBLISHMENT_IND1 ON RFP_PUBLISHMENT (VENDOR_ID);



CREATE TABLE PROPOSAL_TO_RFP (
  PROPOSAL_ID          INTEGER        NOT NULL,
  OWNER_ID             INTEGER        NOT NULL,
  DESCRIPTION          VARCHAR(250)   NOT NULL,
  VALID_UNTIL          TIMESTAMP      NOT NULL,
  SHIPMENT_BY          CHAR(1)        NOT NULL,
  EXTRA_DISCOUNT       DECIMAL(12,2)  NOT NULL,
  TOTAL_PRICE          VARCHAR(80)    NOT NULL,
  CURRENCY             CHAR(3)        NOT NULL,
  USERNAME             VARCHAR(30)    NOT NULL,
  RFP_ID               INTEGER        NOT NULL,
  PURCHASE_ORDER_ID    INTEGER,
  PAYMENT_TYPE         CHAR(1)        NOT NULL,
  PAYMENT_NOTE         VARCHAR(250),
  DELIVERY_NOTE        VARCHAR(250),
    CONSTRAINT PROPOSAL_TO_RFP_PK             PRIMARY KEY (PROPOSAL_ID)
);



CREATE TABLE PROPOSAL_TO_RFP_ITEM (
  PROPOSAL_ID          INTEGER         NOT NULL,
  RFP_ID               INTEGER         NOT NULL,
  LINE                 SMALLINT        NOT NULL,
  MATERIAL_TYPE_ID     VARCHAR(30)     NOT NULL,
  MATERIAL_ID          INTEGER         NOT NULL,
  OWNER_ID             INTEGER         NOT NULL,
  QUANTITY             DECIMAL(12,2)   NOT NULL,
  UNIT                 CHAR(2)         NOT NULL,
  UNIT_PRICE           DECIMAL(12,2)   NOT NULL,
  DISCOUNT_PCT         SMALLINT        NOT NULL,
  TAX_PCT              DECIMAL(4,2)    NOT NULL,
  CURRENCY             CHAR(3)         NOT NULL,
    CONSTRAINT PROPOSAL_TO_RFP_ITEM_PK        PRIMARY KEY (PROPOSAL_ID, RFP_ID, LINE),
    CONSTRAINT PROPOSAL_TO_RFP_ITEMS          FOREIGN KEY (PROPOSAL_ID)      REFERENCES PROPOSAL_TO_RFP (PROPOSAL_ID),
    CONSTRAINT RFP_ITEM_PROPOSALS             FOREIGN KEY (RFP_ID, LINE)     REFERENCES REQUEST_FOR_PROPOSAL_ITEM (RFP_ID, LINE),
    CONSTRAINT RFP_ITEM_PROPOSAL_MATERIAL     FOREIGN KEY (MATERIAL_ID)      REFERENCES MATERIAL (MATERIAL_ID),
    CONSTRAINT RFP_ITEM_PROPOSAL_MAT_TYPE     FOREIGN KEY (MATERIAL_TYPE_ID) REFERENCES MATERIAL_TYPE (MATERIAL_TYPE_ID));

CREATE INDEX PROPOSAL_TO_RFP_ITEM_IND1 ON PROPOSAL_TO_RFP_ITEM (RFP_ID, LINE);
CREATE INDEX PROPOSAL_TO_RFP_ITEM_IND2 ON PROPOSAL_TO_RFP_ITEM (MATERIAL_ID);
CREATE INDEX PROPOSAL_TO_RFP_ITEM_IND3 ON PROPOSAL_TO_RFP_ITEM (MATERIAL_TYPE_ID);



CREATE TABLE PROPOSAL_TO_RFP_DIALOG (
  PROPOSAL_ID          INTEGER         NOT NULL,
  DTIME                TIMESTAMP       NOT NULL,
  DTEXT                VARCHAR(250)    NOT NULL,
  USERNAME             VARCHAR(30)     NOT NULL,
    CONSTRAINT PROPOSAL_TO_RFP_DIALOG_PK      PRIMARY KEY (PROPOSAL_ID, DTIME),
    CONSTRAINT PROPOSAL_TO_RFP_DIALOGS        FOREIGN KEY (PROPOSAL_ID)      REFERENCES PROPOSAL_TO_RFP (PROPOSAL_ID));



CREATE VIEW V_RFP_ITEM_PROPOSAL AS
SELECT R.RFP_ID, R.LINE, T.CAPTION AS RFP_MATERIAL_TYPE, F1.CAPTION AS RFP_MANUFACTURER,
       M1.CAPTION AS RFP_CAPTION, M1.PART_NUMBER AS RFP_PART_NUMBER, R.QUANTITY, R.UNIT, R.SPECIFICATION,
       M2.CAPTION AS MATERIAL_CAPTION, F2.CAPTION MANUFACTURER_CAPTION, M2.PART_NUMBER,
       I.PROPOSAL_ID, I.UNIT_PRICE, I.DISCOUNT_PCT, I.TAX_PCT, I.CURRENCY
  FROM (((REQUEST_FOR_PROPOSAL_ITEM AS R LEFT JOIN MATERIAL_TYPE AS T ON R.MATERIAL_TYPE_ID = T.MATERIAL_TYPE_ID)
         LEFT JOIN MATERIAL AS M1 ON R.MATERIAL_ID = M1.MATERIAL_ID)
        LEFT JOIN MANUFACTURER AS F1 ON M1.MANUFACTURER_ID = F1.MANUFACTURER_ID)
  LEFT JOIN
       (((PROPOSAL_TO_RFP_ITEM AS I LEFT JOIN MATERIAL AS M2 ON I.MATERIAL_ID = M2.MATERIAL_ID)
         LEFT JOIN PROPOSAL_TO_RFP AS P ON I.PROPOSAL_ID = P.PROPOSAL_ID)
        LEFT JOIN MANUFACTURER AS F2 ON M2.MANUFACTURER_ID = F2.MANUFACTURER_ID)
    ON (R.LINE = I.LINE AND R.RFP_ID = I.RFP_ID);
