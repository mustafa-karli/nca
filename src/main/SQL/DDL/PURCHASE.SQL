CREATE TABLE PURCHASE_ORDER (
  PURCHASE_ORDER_ID    INTEGER   NOT NULL,
  OWNER_ID             INTEGER   NOT NULL,
  VENDOR_ID            INTEGER   NOT NULL,
  ORGANIZATION_ID      INTEGER   NOT NULL,
  ORDER_DATE           TIMESTAMP   NOT NULL,
  DUE_DATE             TIMESTAMP,
  STATUS               CHAR(1)   NOT NULL,
  USERNAME             VARCHAR(30)   NOT NULL,
  DESCRIPTION          VARCHAR(250),
  DISCOUNT             DECIMAL(10,2),
  ADVANCE_PAYMENT      DECIMAL(10,2),
  ONLINE_ORDER         CHAR(1),
    CONSTRAINT PURCHASE_ORDER_PK PRIMARY KEY (PURCHASE_ORDER_ID),
    CONSTRAINT PURCHASE_ORDERS FOREIGN KEY (ORGANIZATION_ID) REFERENCES ORGANIZATION (ORGANIZATION_ID)
);

CREATE INDEX PURCHASE_ORDER_IND1 ON PURCHASE_ORDER (ORGANIZATION_ID);
CREATE INDEX PURCHASE_ORDER_IND2 ON PURCHASE_ORDER (OWNER_ID);



CREATE TABLE PURCHASE_ORDER_ITEM (
  PURCHASE_ORDER_ID    INTEGER         NOT NULL,
  LINE                 SMALLINT        NOT NULL,
  MATERIAL_ID          INTEGER         NOT NULL,
  QUANTITY             DECIMAL(10,2)   NOT NULL,
  UNIT                 VARCHAR(3)      NOT NULL,
  UNIT_PRICE           DECIMAL(10,2),
  DISCOUNT             DECIMAL(10,2),
  CURRENCY             VARCHAR(3),
  STATUS               CHAR(1),
    CONSTRAINT PURCHASE_ORDER_ITEM_PK    PRIMARY KEY (PURCHASE_ORDER_ID, LINE),
    CONSTRAINT MATERIALS_PURCHASE_ORDERS FOREIGN KEY (MATERIAL_ID)       REFERENCES MATERIAL (MATERIAL_ID),
    CONSTRAINT PURCHASE_ORDER_ITEMS      FOREIGN KEY (PURCHASE_ORDER_ID) REFERENCES PURCHASE_ORDER (PURCHASE_ORDER_ID) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX PURCHASE_ORDER_ITEM_IND1 ON PURCHASE_ORDER_ITEM (MATERIAL_ID);



CREATE TABLE PURCHASE_ORDER_ITEM_ATTR (
  PURCHASE_ORDER_ID    INTEGER      NOT NULL,
  LINE                 SMALLINT     NOT NULL,
  MAG_ID               VARCHAR(8)   NOT NULL,
  VALUE                VARCHAR(8),
    CONSTRAINT PURCHASE_ORDER_ITEM_ATTR_PK PRIMARY KEY (PURCHASE_ORDER_ID, LINE, MAG_ID),
    CONSTRAINT PURCHASE_ORDER_ITEM_ATTRS   FOREIGN KEY (PURCHASE_ORDER_ID, LINE) REFERENCES PURCHASE_ORDER_ITEM (PURCHASE_ORDER_ID, LINE) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT ATTR_GROUP_PURCHASE_ORDERS  FOREIGN KEY (MAG_ID)                  REFERENCES MATERIAL_ATTRIBUTE_GROUP (MAG_ID)
);

CREATE INDEX PURCHASE_ORDER_ITEM_ATTR_IND3 ON PURCHASE_ORDER_ITEM_ATTR (MAG_ID);



CREATE TABLE PURCHASE_ORDER_TAX (
  PURCHASE_ORDER_ID    INTEGER      NOT NULL,
  LINE                 SMALLINT     NOT NULL,
  TAX_ID               VARCHAR(8)   NOT NULL,
  AMOUNT               DECIMAL(10,2)   NOT NULL,
    CONSTRAINT PURCHASE_ORDER_TAX_PK PRIMARY KEY (PURCHASE_ORDER_ID, LINE, TAX_ID),
    CONSTRAINT PURCHASE_ORDER_TAXES  FOREIGN KEY (PURCHASE_ORDER_ID, LINE) REFERENCES PURCHASE_ORDER_ITEM (PURCHASE_ORDER_ID, LINE) ON DELETE CASCADE ON UPDATE CASCADE
);



CREATE TABLE PURCHASE_REASON (
  PURCHASE_ORDER_ID    INTEGER    NOT NULL,
  LINE                 SMALLINT   NOT NULL,
  REASON_TYPE          CHAR(1)    NOT NULL,
  REASON_ID            INTEGER    NOT NULL,
  REASON_LINE          SMALLINT   NOT NULL,
  BEGDA                TIMESTAMP,
    CONSTRAINT PURCHASE_REASON_PK PRIMARY KEY (PURCHASE_ORDER_ID, LINE, REASON_TYPE, REASON_ID, REASON_LINE),
    CONSTRAINT PURCHASE_REASONS   FOREIGN KEY (PURCHASE_ORDER_ID, LINE) REFERENCES PURCHASE_ORDER_ITEM (PURCHASE_ORDER_ID, LINE) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX PURCHASE_REASON_IND1 ON PURCHASE_REASON (REASON_TYPE, REASON_ID, REASON_LINE);



CREATE TABLE PURCHASE_DELIVERY (
  DELIVERY_ID          INTEGER       NOT NULL,
  OWNER_ID             INTEGER       NOT NULL,
  ORGANIZATION_ID      INTEGER       NOT NULL,
  DELIVERY_DATE        TIMESTAMP     NOT NULL,
  INVOICE_ID           VARCHAR(20),
  USERNAME             VARCHAR(30)   NOT NULL,
    CONSTRAINT PURCHASE_DELIVERY_PK PRIMARY KEY (DELIVERY_ID),
    CONSTRAINT PURCHASE_DELIVERIES  FOREIGN KEY (ORGANIZATION_ID) REFERENCES ORGANIZATION (ORGANIZATION_ID)
);

CREATE INDEX PURCHASE_DELIVERY_IND1 ON PURCHASE_DELIVERY (ORGANIZATION_ID);
CREATE INDEX PURCHASE_DELIVERY_IND2 ON PURCHASE_DELIVERY (OWNER_ID);



CREATE TABLE PURCHASE_DELIVERY_ADDRESS (
  PURCHASE_ORDER_ID    INTEGER    NOT NULL,
  BUSINESS_PARTNER_ID  INTEGER    NOT NULL,
  ADDRESS_ID           SMALLINT   NOT NULL,
    CONSTRAINT PURCHASE_DELIVERY_ADDRESS_PK PRIMARY KEY (PURCHASE_ORDER_ID, BUSINESS_PARTNER_ID, ADDRESS_ID),
    CONSTRAINT PURCHASE_DELIVERY_ADDRESSES  FOREIGN KEY (PURCHASE_ORDER_ID)               REFERENCES PURCHASE_ORDER (PURCHASE_ORDER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT ADDRESS_PURCHASE_DELIVERIES  FOREIGN KEY (BUSINESS_PARTNER_ID, ADDRESS_ID) REFERENCES PARTNER_ADDRESS (BUSINESS_PARTNER_ID, ADDRESS_ID)
);

CREATE INDEX PURCHASE_DELIVERY_ADDRESS_IND1 ON PURCHASE_DELIVERY_ADDRESS (BUSINESS_PARTNER_ID, ADDRESS_ID);



CREATE TABLE PURCHASE_DELIVERY_LINE (
  DELIVERY_ID          INTEGER         NOT NULL,
  PURCHASE_ORDER_ID    INTEGER         NOT NULL,
  LINE                 SMALLINT        NOT NULL,
  MATERIAL_ID          INTEGER         NOT NULL,
  QUANTITY             DECIMAL(10,2)   NOT NULL,
  UNIT                 VARCHAR(3),
    CONSTRAINT PURCHASE_DELIVERY_LINE_PK      PRIMARY KEY (DELIVERY_ID, PURCHASE_ORDER_ID, LINE),
    CONSTRAINT PURCHASE_DELIVERY_LINES        FOREIGN KEY (DELIVERY_ID)             REFERENCES PURCHASE_DELIVERY (DELIVERY_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT PURCHASE_ORDER_ITEM_DELIVERIES FOREIGN KEY (PURCHASE_ORDER_ID, LINE) REFERENCES PURCHASE_ORDER_ITEM (PURCHASE_ORDER_ID, LINE),
    CONSTRAINT MATERIAL_PURCHASE_DELIVERIES   FOREIGN KEY (MATERIAL_ID)             REFERENCES MATERIAL (MATERIAL_ID)
);

CREATE INDEX PURCHASE_DELIVERY_LINE_IND1 ON PURCHASE_DELIVERY_LINE (PURCHASE_ORDER_ID, LINE);
CREATE INDEX PURCHASE_DELIVERY_LINE_IND2 ON PURCHASE_DELIVERY_LINE (MATERIAL_ID);
