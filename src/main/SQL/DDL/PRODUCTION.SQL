CREATE TABLE PRODUCTION_RESOURCE (
  ORGANIZATION_ID      INTEGER      NOT NULL,
  RESOURCE_TYPE        VARCHAR(8)   NOT NULL,
  QUANTITY             INTEGER      NOT NULL,
  UNIT                 VARCHAR(3)   NOT NULL,
    CONSTRAINT PRODUCTION_RESOURCE_PK PRIMARY KEY (RESOURCE_TYPE, ORGANIZATION_ID),
    CONSTRAINT PRODUCTION_RESOURCES   FOREIGN KEY (ORGANIZATION_ID) REFERENCES ORGANIZATION (ORGANIZATION_ID)
);



CREATE TABLE BOM_OPERATION (
  BOM_OPERATION_ID     INTEGER      NOT NULL,
  MATERIAL_ID          INTEGER      NOT NULL,
  CAPTION              VARCHAR(80)  NOT NULL,
  FACILITY_TYPE        VARCHAR(8)   NOT NULL,
  SETUP_TIME           INTEGER      NOT NULL,
  UNIT_TIME            INTEGER      NOT NULL,
  MAKEUP_TIME          INTEGER      NOT NULL,
  PRODUCTION_UNIT      VARCHAR(3)   NOT NULL,
    CONSTRAINT BOM_OPERATION_PK PRIMARY KEY (BOM_OPERATION_ID),
    CONSTRAINT BOM_OPERATIONS   FOREIGN KEY (MATERIAL_ID) REFERENCES MATERIAL (MATERIAL_ID)
);

CREATE INDEX BOM_OPERATION_IND1 ON BOM_OPERATION (MATERIAL_ID);



CREATE TABLE BOM_OPERATION_STEP (
  BOM_OPERATION_ID     INTEGER   NOT NULL,
  STEP                 SMALLINT  NOT NULL,
  MATERIAL_ID          INTEGER   NOT NULL,
  LEAD_TIME            INTEGER,
  QUANTITY             DECIMAL(10,2),
  UNIT                 VARCHAR(3),
    CONSTRAINT BOM_OPERATION_STEP_PK        PRIMARY KEY (BOM_OPERATION_ID, STEP),
    CONSTRAINT BOM_OPERATION_STEPS          FOREIGN KEY (BOM_OPERATION_ID) REFERENCES BOM_OPERATION (BOM_OPERATION_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT BOM_OPERATION_STEP_MATERIALS FOREIGN KEY (MATERIAL_ID) REFERENCES MATERIAL (MATERIAL_ID)
);

CREATE INDEX BOM_OPERATION_STEP_IND1 ON BOM_OPERATION_STEP (MATERIAL_ID);



CREATE TABLE BOM_OPERATION_STEP_RESOURCE (
  BOM_OPERATION_ID     INTEGER   NOT NULL,
  STEP                 SMALLINT   NOT NULL,
  RESOURCE_TYPE        VARCHAR(8)  NOT NULL,
  UNIT_DURATION        INTEGER,
    CONSTRAINT BOM_OPERATION_STEP_RESOURCE_PK PRIMARY KEY (BOM_OPERATION_ID, STEP, RESOURCE_TYPE),
    CONSTRAINT BOM_OPERATION_STEP_RESOURCES   FOREIGN KEY (BOM_OPERATION_ID, STEP) REFERENCES BOM_OPERATION_STEP (BOM_OPERATION_ID, STEP) ON DELETE CASCADE ON UPDATE CASCADE
);



CREATE TABLE PRODUCTION_ORDER (
  PRODUCTION_ORDER_ID  INTEGER   NOT NULL,
  OWNER_ID             INTEGER   NOT NULL,
  ORGANIZATION_ID      INTEGER   NOT NULL,
  ORDER_DATE           TIMESTAMP,
  DUE_DATE             TIMESTAMP,
  STATUS               CHAR(1),
  USERNAME             VARCHAR(30),
  DESCRIPTION          VARCHAR(250),
    CONSTRAINT PRODUCTION_ORDER_PK PRIMARY KEY (PRODUCTION_ORDER_ID),
    CONSTRAINT PRODUCTION_ORDERS   FOREIGN KEY (ORGANIZATION_ID) REFERENCES ORGANIZATION (ORGANIZATION_ID)
);

CREATE INDEX PRODUCTION_ORDER_IND1 ON PRODUCTION_ORDER (OWNER_ID);
CREATE INDEX PRODUCTION_ORDER_IND2 ON PRODUCTION_ORDER (ORGANIZATION_ID);



CREATE TABLE PRODUCTION_ORDER_ITEM (
  PRODUCTION_ORDER_ID  INTEGER        NOT NULL,
  LINE                 SMALLINT       NOT NULL,
  MATERIAL_ID          INTEGER        NOT NULL,
  QUANTITY             DECIMAL(10,2)  NOT NULL,
  UNIT                 VARCHAR(3)     NOT NULL,
  STATUS               CHAR(1)        NOT NULL,
    CONSTRAINT PRODUCTION_ORDER_ITEM_PK    PRIMARY KEY (PRODUCTION_ORDER_ID, LINE),
    CONSTRAINT PRODUCTION_ORDER_ITEMS      FOREIGN KEY (PRODUCTION_ORDER_ID) REFERENCES PRODUCTION_ORDER (PRODUCTION_ORDER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT MATERIALS_PRODUCTION_ORDERS FOREIGN KEY (MATERIAL_ID) REFERENCES MATERIAL (MATERIAL_ID)
);

CREATE INDEX PRODUCTION_ORDER_ITEM_IND2 ON PRODUCTION_ORDER_ITEM (MATERIAL_ID);



CREATE TABLE PRODUCTION_JOB (
  PRODUCTION_JOB_ID    INTEGER    NOT NULL,
  ORGANIZATION_ID      INTEGER    NOT NULL,
  PRODUCTION_ORDER_ID  INTEGER    NOT NULL,
  LINE                 SMALLINT   NOT NULL,
  BOM_OPERATION_ID     INTEGER    NOT NULL,
    CONSTRAINT PRODUCTION_JOB_PK             PRIMARY KEY (PRODUCTION_JOB_ID),
    CONSTRAINT PRODUCTION_ORDER_ITEM_JOBS    FOREIGN KEY (PRODUCTION_ORDER_ID, LINE) REFERENCES PRODUCTION_ORDER_ITEM (PRODUCTION_ORDER_ID, LINE),
    CONSTRAINT BOM_OPERATION_PRODUCTION_JOBS FOREIGN KEY (BOM_OPERATION_ID)          REFERENCES BOM_OPERATION (BOM_OPERATION_ID),
    CONSTRAINT ORGANIZATIONS_PRODUCTION_JOBS FOREIGN KEY (ORGANIZATION_ID)           REFERENCES ORGANIZATION (ORGANIZATION_ID)
);

CREATE INDEX PRODUCTION_JOB_IND1 ON PRODUCTION_JOB (PRODUCTION_ORDER_ID, LINE);
CREATE INDEX PRODUCTION_JOB_IND2 ON PRODUCTION_JOB (BOM_OPERATION_ID);
CREATE INDEX PRODUCTION_JOB_IND4 ON PRODUCTION_JOB (ORGANIZATION_ID);



CREATE TABLE PRODUCTION_JOB_RESOURCE (
  PRODUCTION_JOB_ID    INTEGER   NOT NULL,
  ORGANIZATION_ID      INTEGER   NOT NULL,
  RESOURCE_TYPE        VARCHAR(8)   NOT NULL,
  QUANTITY             INTEGER,
  BEGDA                TIMESTAMP,
  DURATION             INTEGER,
    CONSTRAINT PRODUCTION_JOB_RESOURCE_PK PRIMARY KEY (PRODUCTION_JOB_ID, RESOURCE_TYPE, ORGANIZATION_ID),
    CONSTRAINT PRODUCTION_JOB_RESOURCES   FOREIGN KEY (PRODUCTION_JOB_ID)              REFERENCES PRODUCTION_JOB      (PRODUCTION_JOB_ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT PRODUCTION_RESOURCE_JOBS   FOREIGN KEY (ORGANIZATION_ID, RESOURCE_TYPE) REFERENCES PRODUCTION_RESOURCE (ORGANIZATION_ID, RESOURCE_TYPE)
);

CREATE INDEX PRODUCTION_JOB_RESOURCE_IND2 ON PRODUCTION_JOB_RESOURCE (ORGANIZATION_ID, RESOURCE_TYPE);



CREATE TABLE PRODUCTION_LINE_REASON (
  PRODUCTION_ORDER_ID  INTEGER    NOT NULL,
  LINE                 SMALLINT   NOT NULL,
  ORDER_TYPE           CHAR(1)    NOT NULL,
  ORDER_ID             INTEGER    NOT NULL,
  ORDER_LINE           SMALLINT   NOT NULL,
  PRIORITY             SMALLINT   NOT NULL,
    CONSTRAINT PRODUCTION_LINE_REASON_PK PRIMARY KEY (PRODUCTION_ORDER_ID, LINE, ORDER_TYPE, ORDER_ID, ORDER_LINE),
    CONSTRAINT PRODUCTION_LINE_REASONS   FOREIGN KEY (PRODUCTION_ORDER_ID, LINE) REFERENCES PRODUCTION_ORDER_ITEM (PRODUCTION_ORDER_ID, LINE) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX PRODUCTION_LINE_REASON_IND1 ON PRODUCTION_LINE_REASON (ORDER_TYPE, ORDER_ID, ORDER_LINE);
